/* autogenerated by Processing revision 1292 on 2023-03-20 */
import processing.core.*;
import processing.data.*;
import processing.event.*;
import processing.opengl.*;

import ModbusRTU.*;
import de.re.easymodbus.exceptions.*;
import de.re.easymodbus.modbusclient.*;
import de.re.easymodbus.modbusclient.gui.*;
import de.re.easymodbus.server.*;
import de.re.easymodbus.server.gui.*;

import websockets.*;
import netP5.*;
import oscP5.*;

import java.util.HashMap;
import java.util.ArrayList;
import java.io.File;
import java.io.BufferedReader;
import java.io.PrintWriter;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.IOException;

public class sendRobotState extends PApplet {






JSONObject projectSettings;




int portNumber = 502;
//String robotIP = "192.168.1.100";
String robotIP = "10.88.111.40";
RobotControl tellRobot;


//osc setup
OscP5 oscP5;
int sendPort = 8000;
int listenPort = 9000;
String sendIP = "localhost";
int registerNumber = 200;
String addressName = "/robotState";

public void setup()
{
/* size commented out by preprocessor */;


projectSettings = loadJSONObject("settings.json");
robotIP = projectSettings.getString("robotIP");
registerNumber = projectSettings.getInt("registerNumber");
addressName = projectSettings.getString("addressName");


//connect to the robot
tellRobot = new RobotControl(robotIP, portNumber, registerNumber);
tellRobot.connect();
rectMode(CORNERS);

oscP5 = new OscP5(this, listenPort);




}



public void draw()
{
background(0);
fill(255);
tellRobot.sendRobotState();
textSize(40);
text("Robot IP: " + robotIP, 10, 50);
textSize(20);
text("Register Number: " + registerNumber, 10, 80);
text("OSC message address: " + addressName, 10, 110);
text("OSC message port: " + listenPort, 10, 140);
textSize(40);
text("Robot State: " + tellRobot.robotState, 10, 200);


}
public float roundTo(float thenumber, int decimalPlaces)
{
 float rFloat = thenumber;
 String rString = "";

try {
    rString = nf(thenumber,0,decimalPlaces);
}
catch(ArrayIndexOutOfBoundsException exception) {
    
}

if(rString.length()>0)
{
  rFloat = Float.parseFloat(rString);
}  
  return rFloat;
}
public void oscEvent(OscMessage theOscMessage) {
 // println(theOscMessage);
  if (theOscMessage.checkAddrPattern(addressName)==true) {
    tellRobot.robotState = theOscMessage.get(0).intValue();
    //println("Received state: " + tellRobot.robotState);
    tellRobot.sendRobotState();
  }
}
class RobotControl
{
ModbusClient writeClient;
String serverIP;
int serverPort = 502;
int robotState = 0;
int regNumber = 200;


    RobotControl(String _serverIP, int _serverPort, int _regNumber)
    {
        
        serverIP = _serverIP;
        serverPort = _serverPort;
        regNumber = _regNumber;
        
        
    }

    public void connect()
    {
        writeClient = new ModbusClient(serverIP, serverPort);

        try
        {
            writeClient.Connect();
            println("Connected to server");
        }
        catch (Exception e)
        {
            println("Error connecting to server");
        }
        
    }

    public void sendRobotState()
    {
        if(writeClient.isConnected())
        {
            stroke(0, 255, 0);
            strokeWeight(10);
            noFill();
            rect(0,0, width, height);
            try
            {
                writeClient.WriteSingleRegister(regNumber, robotState);
               // println("Sent state: " + robotState);
            }
            catch (Exception e)
            {
                println("Error sending state");
            }
        }
        else
        {

            println("Not connected to server");
            connect();
        }

    }


public void oscEvent(OscMessage theOscMessage) {
  println(theOscMessage);
  if (theOscMessage.checkAddrPattern(addressName)==true) {
    robotState = theOscMessage.get(0).intValue();
    println("Received state: " + robotState);
    sendRobotState();
  }
}

 







}


  public void settings() { size(500, 240); }

  static public void main(String[] passedArgs) {
    String[] appletArgs = new String[] { "sendRobotState" };
    if (passedArgs != null) {
      PApplet.main(concat(appletArgs, passedArgs));
    } else {
      PApplet.main(appletArgs);
    }
  }
}
